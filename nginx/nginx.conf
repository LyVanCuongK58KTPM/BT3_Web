events {
  worker_connections  1024;
}

http {
  sendfile off; 

  server {
    listen 80;
    server_name lyvancuong.com;

    # 1. PHỤC VỤ WEB SPA (Chỉ GET)
    location / {
      root /usr/share/nginx/html; 
      index index.html;
      try_files $uri $uri/ /index.html;
    }
    
    # 2. PROXY API (Sửa lỗi 405)
    # Khối này cho phép POST /api/login
    location /api/ {
      # Chuyển tiếp TẤT CẢ request /api/... sang Node-RED
      # Node-RED (chạy ở gốc) sẽ nhận được /api/login
      proxy_pass http://nodered_service:1880/api/; 
      
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 3. PROXY NODE-RED GIAO DIỆN (Sửa lỗi "Cannot GET /nodered/")
    location = /nodered {
      return 301 /nodered/;
    }

    location /nodered/ {
      # Dấu / ở cuối là RẤT QUAN TRỌNG
      # Nó "cắt" /nodered/ và gửi phần còn lại đến Node-RED
      proxy_pass http://nodered_service:1880/; 
      
      proxy_set_header Host $host;
      proxy_set_header Connection "upgrade";
      proxy_set_header Upgrade $http_upgrade;
    }
    
    # 4. PROXY GRAFANA (Giữ nguyên)
    location = /grafana {
      return 301 /grafana/;
    }

    location /grafana/ {
      proxy_pass http://grafana_service:3000/grafana/;
      proxy_set_header Host $host;
    }
  }
}